<h1>Triple Translatorï¼ˆæ—¥æœ¬èªãƒ»è‹±èªãƒ»éŸ“å›½èª åŒæ™‚ç¿»è¨³ãƒ„ãƒ¼ãƒ«ï¼‰</h1>
<p>
  æ—¥æœ¬èªã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è‹±èªã¨éŸ“å›½èªã«åŒæ™‚ç¿»è¨³ã—ã¦ãã‚Œã‚‹Webã‚¢ãƒ—ãƒªã§ã™ã€‚
  éŸ“å›½ã®å‹ã ã¡ã¨ã®ãƒãƒ£ãƒƒãƒˆã‚„ã€è‹±èªãƒ»éŸ“å›½èªã®å‹‰å¼·ã«ä½¿ãˆã¾ã™ã€‚
</p>

<div class="translator-container">
  <div class="pane jp">
    <div class="pane-header">
      <h2>æ—¥æœ¬èª</h2>
      <button type="button" data-lang="ja" class="speak-btn">ğŸ”Š èª­ã¿ä¸Šã’</button>
    </div>
    <textarea id="input-text" rows="10" placeholder="ã“ã“ã«æ—¥æœ¬èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
  </div>

  <div class="pane en">
    <div class="pane-header">
      <h2>English</h2>
      <button type="button" data-lang="en" class="speak-btn">ğŸ”Š èª­ã¿ä¸Šã’</button>
    </div>
    <textarea id="english-text" rows="10" readonly></textarea>
  </div>

  <div class="pane ko">
    <div class="pane-header">
      <h2>í•œêµ­ì–´</h2>
      <button type="button" data-lang="ko" class="speak-btn">ğŸ”Š èª­ã¿ä¸Šã’</button>
    </div>
    <textarea id="korean-text" rows="10" readonly></textarea>
  </div>
</div>

<script>
  // ===== 1) å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¿»è¨³ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰ =====
  const inputEl   = document.getElementById("input-text");
  const englishEl = document.getElementById("english-text");
  const koreanEl  = document.getElementById("korean-text");

  let timer = null;

  inputEl.addEventListener("input", () => {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => {
      const text = inputEl.value;

      fetch("<%= realtime_translation_path %>", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ text: text })
      })
      .then(res => res.json())
      .then(data => {
        englishEl.value = data.english || "";
        koreanEl.value  = data.korean  || "";
      })
      .catch(err => {
        console.error("translate error", err);
      });
    }, 500); // 0.5ç§’å…¥åŠ›æ­¢ã¾ã£ãŸã‚‰ç¿»è¨³
  });

  // ===== 2) éŸ³å£°èª­ã¿ä¸Šã’ =====
async function speakFromServer(text, lang) {
  if (!text) return;

  const res = await fetch("/tts", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({ text: text, lang: lang })
  });

  if (!res.ok) {
    console.error("TTS error", await res.text());
    return;
  }

  // éŸ³å£°ãƒã‚¤ãƒŠãƒªãŒè¿”ã£ã¦ãã‚‹ã®ã§ã€URL ã‚’ä½œã£ã¦å†ç”Ÿ
  const blob = await res.blob();
  const url  = URL.createObjectURL(blob);
  const audio = new Audio(url);
  audio.play();
}

document.querySelectorAll(".speak-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const lang = btn.dataset.lang;
    let text = "";
    if (lang === "ja-JP" || lang === "ja") text = inputEl.value;
    if (lang === "en-US" || lang === "en") text = englishEl.value;
    if (lang === "ko-KR" || lang === "ko") text = koreanEl.value;

    const langCode =
      lang === "ja" ? "ja-JP" :
      lang === "en" ? "en-US" :
      lang === "ko" ? "ko-KR" : lang;

    speakFromServer(text, langCode);
  });
});

</script>
